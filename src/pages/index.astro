---
import App, { HOBBIES } from '../app/App';
import '@/styles/index.css';
import { PROJECTS } from '@/data/projects';
import { fetchOgp, type OgpData } from '@/lib/ogp';

const urlSet = new Set<string>();

PROJECTS.forEach((group: (typeof PROJECTS)[number]) => {
  group.items.forEach((item: (typeof PROJECTS)[number]['items'][number]) => {
    if (item.playLink) {
      urlSet.add(item.playLink.url);
    }
    item.relatedLinks?.forEach(
      (link: NonNullable<(typeof PROJECTS)[number]['items'][number]['relatedLinks']>[number]) =>
        urlSet.add(link.url),
    );
  });
});

HOBBIES.forEach((hobby) => {
  hobby.favorites?.forEach((favorite) => urlSet.add(favorite.url));
});

const ogpEntries = await Promise.all(
  Array.from(urlSet).map(async (url) => {
    const data = await fetchOgp(url);
    if (data) {
      return [url, data] as const;
    }

    let host = url;
    try {
      host = new URL(url).hostname;
    } catch {
      host = url;
    }

    return [
      url,
      {
        url,
        title: url,
        siteName: host,
        description: host,
      },
    ] as const;
  }),
);

const ogpData = Object.fromEntries(ogpEntries) as Record<string, OgpData>;
---

<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href={`${import.meta.env.BASE_URL}favicon.svg`} />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<meta property="og:title" content="どぐえぐ" />
		<meta property="og:description" content="どぐえぐのホームページです。" />
		<meta property="og:image" content="/images/dogegg_icon.png" />
		<meta property="og:url" content="https://dogegg.github.io/dogegg" />
		<meta property="og:type" content="website" />
		<title>どぐえぐ</title>
	</head>
	<body>
		<App client:load ogpData={ogpData} />
	</body>
</html>
